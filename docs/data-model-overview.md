# IMMARKUS Data Model and File Structure

IMMARKUS stores all user data **locally on the user's computer in JSON files** (using the [showDirectoryPicker browser API](https://developer.mozilla.org/en-US/docs/Web/API/Window/showDirectoryPicker)). This architecture choice was made for several reasons:
- It keeps the architecture simple & privacy-friendlyâ€“local-only with no need for cloud storage and online database.
- It avoids the use of storage mechanisms built into the browser (such as [localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage) or [IndexedDB](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API)), which 
browsers may purge unexpectedly, e.g. after two weeks of inactivity.
- It simplifies handling of large files, especially images.

---

## 1. Core Project Files

When the user launches IMMARKUS, they must specify a **project folder**, and grant IMMARKUS access to it. This folder serves as the root directory for all project-related data. IMMARKUS stores core project-level information in two key files:

### _immarkus.model.json
This file contains the **data model definitions**, including:
- **Entity classes** and their properties.
- **Relationship types** between entities.
- Definitions for **image and folder metadata** schemas.

These definitions are editable by the user in the **Data Model** tab of IMMARKUS.

### _immarkus.relations.json
This file stores **relationships between annotations** across the project. Since annotations can link entities on different images, these relationships are stored at the global (root) level.

---

## 2. Image-Specific Files

IMMARKUS recursively loads images from the root project folder and its subfolders. Annotations and metadata for each image are stored in a JSON file named `[image-filename].json`. These files adhere to the [W3C Web Annotation Data Model](https://www.w3.org/TR/annotation-model/).

### Structure of Image Annotation Files
Each annotation file contains one or more annotations including the following key elements:

- `id`: a UUID identifier for the annotation.
- `target`: specifies the annotated image region.
  - The `target.source` field contains the image filename.
  - The `target.selector` field identifies the annotated region. IMMARKUS uses:
    - `FragmentSelector` for rectangular regions.
    - `SvgSelector` for polygon and ellipse regions.
- `body`: the annotation payload. Each body can be one of the following:
  - **Entity Tag:** used to classify the image region with an Entity Class from the user's data model.
    - `type`: `Dataset`
    - `purpose`: `classifying`
    - `source`: the Entity Class ID in the data model.
    - `properties`: A JSON object containing user-defined properties for the entity.
  - **Notes:** Free-text comments added by the user.
    - `type`: `TextualBody`
    - `purpose`: `commenting`
    - `value`: The comment text.

### Image Metadata Annotation
In addition to region-specific annotations, each image may have a metadata annotation. This annotation:
- has a `target` without a `selector` (since it applies to the entire image).
- contains one `body` with:
  - `purpose`: `describing`
  - `source`: the metadata schema name in the data model.
  - `properties`: a JSON object containing user-defined metadata.

#### Example 1: Image Annotation (Two Entity Tags and One Note)
```jsonc
{
  "@context": "http://www.w3.org/ns/anno.jsonld",
  "type": "Annotation",
  "id": "cc21de14-b392-4e10-81ab-43f6f00eac64",
  "target": {
    "source": "image-filename",
    "selector": {
      "type": "FragmentSelector",
      "conformsTo": "http://www.w3.org/TR/media-frags/",
      "value": "xywh=pixel:<x,y,width,height>"
    }
  },
  "body": [
    {
      "type": "Dataset",
      "purpose": "classifying",
      "source": "my-entity-class-a",
      "properties": {
        // Entity-specific properties
      }
    },
    {
      "type": "Dataset",
      "purpose": "classifying",
      "source": "my-entity-class-b",
      "properties": {
        // Entity-specific properties
      }
    },
    {
      "type": "TextualBody",
      "purpose": "commenting",
      "value": "A note..."
    }
  ]
}
```

#### Example 2: Image Metadata Annotation
```jsonc
{
  "@context": "http://www.w3.org/ns/anno.jsonld",
  "type": "Annotation",
  "id": "6ef8d60f-5f54-4e70-a72d-db9cebb6d8e2",
  "target": {
    "source": "image-filename"
  },
  "body": {
    "source": "artwork",
    "properties": {
      // Schema-specific properties
    },
    "purpose": "describing"
  }
}
```
---

## 3. IIIF-Specific Files

IMMARKUS supports annotations on IIIF resources. When a user imports a IIIF manifest, only minimal metadata is stored locally. The manifest itself is fetched online from the repository.

### IIIF Manifest Metadata

Imported IIIF sources are recorded in a JSON file named `_iiif.[manifest-id].json`. This file contains:

- A unique `id` generated by IMMARKUS (distinct from the manifest's URI!)
- The manifest's `name`, `uri`, and presentation API `majorVersion`.
- A list of `canvases`, each with:
  - An IMMARKUS-generated `id`.
  - The canvas's `uri` and `name`.

#### Example:

```json
{
  "id": "manifest-id",
  "name": "manifest-title",
  "uri": "manifest-uri",
  "type": "PRESENTATION_MANIFEST",
  "majorVersion": 2,
  "canvases": [
    {
      "id": "canvas-id",
      "uri": "canvas-uri",
      "name": "canvas-label",
      "manifestId": "manifest-id"
    }
  ]
}
```

### IIIF Annotations

Annotations on IIIF resources are stored in a JSON file named `_iiif.[manifest-id].annotations.json`. These files follow the same structure as image annotation files, with one key difference:

- The source field in the target object uses the format: `"iiif:manifest-id:canvas-id"`, where
  - `iiif:` identifies the source as a IIIF resource.
  - `manifest-id` is the internal manifest ID from the IIIF manifest metadata file.
  - `canvas-id` is the internal canvas ID from the IIIF manifest metadata file.

#### Example:

```json
{
  "target": {
    "source": "iiif:manifest-id:canvas-id",
    "selector": {
      "type": "FragmentSelector",
      "value": "xywh=pixel:x,y,width,height"
    }
  }
}
```

---

## 4. Folder Metadata

IMMARKUS also supports metadata at the folder level. Each folder (including the root project folder) can contain a JSON file named `_immarkus.folder.meta.json`. This file stores user-provided metadata for the folder and follows the W3C Web Annotation Data Model.

### Structure of Folder Metadata Files

- The annotation has no explicit `target` (the folder is implied).
- The `body` contains:
  - `source`: identifies the metadata schema from the data model.
  - `properties`: a JSON object containing user-defined metadata.

#### Example:

```json
{
  "@context": "http://www.w3.org/ns/anno.jsonld",
  "type": "Annotation",
  "id": "ccfd804c-2733-4725-a779-51f4326a9fe4",
  "body": {
    "source": "artwork",
    "properties": {
      "Image_title_ch": "Test"
    },
    "purpose": "describing"
  }
}
```
---

## Summary

IMMARKUS organizes project data via structured JSON files:

- **Project-level files** define the global data model and relationships.
- **Image-specific files** store annotations and metadata using W3C Web Annotation standards.
- **IIIF metadata files** maintain references to imported IIIF manifests and their annotations.
- **Folder metadata files** store descriptive metadata at the directory level.

